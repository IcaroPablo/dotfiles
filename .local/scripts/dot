#!/bin/sh

DOTFILES_BARE_REPO="$HOME/.config/dotfiles"

alias git_cmd="git --git-dir=$DOTFILES_BARE_REPO"

usage() {
    printf "Dot is a script for managing dotfiles\n\nUsage:\n\n    dot [start <git repo> | <git command>]\n\n"
}

initial_setup() {
    git_cmd init --bare "$DOTFILES_BARE_REPO"
    git_cmd branch -m main
    git_cmd config --local status.showUntrackedFiles no

    if [ ! -f "$HOME/.gitignore" ] || [ ! $(grep -q "$DOTFILES_BARE_REPO" "$HOME/.gitignore") ]; then
        dotfiles_repo="$(perl -le 'use File::Spec; print File::Spec->abs2rel(@ARGV)' $DOTFILES_BARE_REPO $HOME)"
        echo "$dotfiles_repo" >> "$HOME/.gitignore"
    fi
}

start() {
    if [ -n "$1" ]; then
        dotfiles_repo="$(perl -le 'use File::Spec; print File::Spec->abs2rel(@ARGV)' $DOTFILES_BARE_REPO $HOME)"
        echo "make sure your git repo ignores $dotfiles_repo (Abort/ok)"
        read -r answer
        [[ "$answer" == [aA] ]] || [[ -z "$answer" ]] && echo "aborting" && exit 1
        git clone --bare "$1" "$DOTFILES_BARE_REPO"
    else
        git_cmd rev-parse --is-bare-repository 1>/dev/null \
            && echo "already set up in $DOTFILES_BARE_REPO" \
            || initial_setup
    fi
}

case "$1" in
    "") usage;;
    "start") start "$2" ;;
    *) git_cmd --work-tree=$HOME "$@" ;;
esac
